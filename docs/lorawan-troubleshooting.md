# LoRaWAN OTAA Join Troubleshooting Guide

## Overview

This guide covers common LoRaWAN OTAA join issues, particularly when switching devices between network servers (TTN, TTI, Helium, ChirpStack, AWS IoT Core for LoRaWAN, etc.).

---

## Issue 1: JoinNonce / DevNonce Mismatch (Security Replay Protection)

### Background

**All LoRaWAN versions implement replay attack protection** but there is a difference is in how strictly it's enforced:

| Version | DevNonce (Device → Network) | JoinNonce (Network → Device) |
|---------|---------------------------|------------------------------|
| LoRaWAN 1.0.3 and earlier | Must be **different** from previous | Must be **different** from previous |
| LoRaWAN 1.0.4+ | Must be **strictly greater** than previous | Must be **strictly greater** than previous |

- **DevNonce**: Generated by the device, sent in join request. The LNS validates this.
- **JoinNonce**: Generated by the Join Server, sent in join-accept. The device validates this.

The DevNonce is more likely to cause issues because LNS implementations are robust, but device-side implementations may have bugs or limited storage.

### Symptom

Device debug UART shows:
```
  * Receive a Valid downlink RX1 for stack_id = 0
 update join procedure
WARN: JoinNonce invalid (new:1 == prev:1)
WARN: Not Joined
```

The device **receives** a join-accept downlink but **rejects** it.

### Root Cause

The device stores the last JoinNonce received from the network. New join-accepts must have an increasing JoinNonce (strictly greater in 1.0.4+, just different in 1.0.3).

**When this happens:**
1. Device was previously joined to a network (e.g., old LNS, different tenant)
2. Device stored JoinNonce (e.g., 727) from that network
3. You create a **new device** on a different network server with the same DevEUI
4. New network's Join Server starts fresh with JoinNonce=1
5. Device receives JoinNonce=1, compares to stored 727, rejects it as a replay

### Diagnosis

Look for this pattern in device debug output:
```
JoinNonce = 0xd7 02 00, NetID = 0x22 00 00
```

- **JoinNonce stored**: 0x0002d7 = 727 (from previous network)
- **NetID stored**: Different from current network

### Solutions

#### Option 1: Wait for JoinNonce to Catch Up

The Join Server increments JoinNonce with each join attempt. If stored JoinNonce is low (< 1000):

1. Let device retry joins (39-42 second intervals)
2. Each gateway-received join request increments the network's JoinNonce
3. Eventually network's JoinNonce exceeds device's stored value
4. Join succeeds

**Note**: Only works if join requests are reaching the gateway.

#### Option 2: Reset Device JoinNonce

Erase stored LoRaWAN configuration on the device:
```bash
# Device-specific commands vary - consult your module documentation
# For OxTech MCM with oxit_cli:
oxit_cli erase
oxit_cli reboot
```

**Important**: Some devices persist JoinNonce in separate flash region. Full factory reset may be required.

#### Option 3: Enable "Reset Join Nonces" on Network Server (Testing Only)

Some LNS platforms (e.g., TTI/TTN, ChirpStack) have a device setting to reset join nonces.

> **Warning**: This is insecure and makes your device susceptible to replay attacks. Use only for development/testing.

This allows the network to accept any DevNonce and resets JoinNonce handling.

#### Option 4: Delete and Recreate Device on Network Server

Delete the device from all network server components and recreate:

1. Delete from Identity Server
2. Delete from Join Server
3. Delete from Network Server
4. Delete from Application Server
5. Recreate fresh (Join Server starts with JoinNonce=0)

---

## Issue 2: Sub-Band / Region Mismatch

### Symptom

Device sends join requests but never receives a response:
```
Tx LoRa at 9188 ms: freq:904600000, SF10, BW125, len 23 bytes 22 dBm
  * RX1 Timeout for stack_id = 0
  * RX2 Timeout for stack_id = 0
INFO: Event received: JOINFAIL
```

### Root Cause

Device and gateway are configured for different sub-bands or regions.

**Common scenarios:**
- Device is on US915 FSB2, gateway is on FSB1
- Device is on EU868, gateway is on US915
- 8-channel gateway only listens on a subset of frequencies

### Diagnosis

- Verify the device's regional parameters match the gateway
- For US915, confirm which FSB (Frequency Sub-Band) both are using
- Note: With an 8-channel gateway, the device may take longer to join because it cycles through all channels before hitting one the gateway is listening on

### Solution

Configure device for the correct region and sub-band:
```cpp
// Example: Set US915 FSB2
lorawan_set_region(REGION_US915);
lorawan_set_subband(2);  // FSB2 = channels 8-15
```

---

## Issue 3: Device Timing / Crystal Calibration

### Symptom

Join requests send successfully, gateway forwards them, network sends join-accept, but device never receives it:
```
Tx LoRa at 9188 ms: freq:904600000, SF10, BW125
  * RX1 Timeout for stack_id = 0
  * RX2 Timeout for stack_id = 0
```

Network logs show join-accept was sent, but device reports RX timeout.

### Root Cause

Device timing is off by several milliseconds, causing it to miss the RX windows.

**LoRaWAN timing is strict:**
- RX1 opens exactly 1 second after TX ends (configurable via RX1 Delay)
- RX2 opens exactly 2 seconds after TX ends
- Windows are typically only open for a few symbols

If your device's crystal is poorly calibrated, it may open the RX window too early or too late.

### Diagnosis

- Compare device's expected RX timing vs actual
- Check crystal calibration / CTUNE values
- Try extending RX window duration for testing

### Solution

1. Verify crystal calibration on your device
2. Check that RX window timing matches what the network expects
3. Consider using a temperature-compensated crystal (TCXO) for production

---

## Issue 4: JoinEUI Not Claimed/Routed (SILENT DROP)

### Symptom

Device debug shows transmission with no response:
```
Tx LoRa at 9188 ms: freq:904600000, SF10, BW125, len 23 bytes 22 dBm
  * RX1 Timeout for stack_id = 0
  * RX2 Timeout for stack_id = 0
INFO: Event received: JOINFAIL
```

**Critical clue**: Network server events show **ZERO events** for your device, even though:
- Gateway is online and receiving uplinks from other devices
- Device is properly registered
- AppKey is correctly configured
- Frequency plans match

### Root Cause

**The JoinEUI prefix is not claimed/routed on your network tenant.**

When a gateway forwards a join request, the Network Server looks at the JoinEUI to determine which Join Server should handle it. If the JoinEUI prefix isn't claimed by your tenant, the packet is **silently dropped**.

### Why This Happens

Network servers use JoinEUI prefixes for global routing (via Packet Broker and interop). Some prefixes are pre-registered:
- Vendor-specific OUI prefixes
- Network's test prefixes
- Custom prefixes - **Must be explicitly claimed per-tenant**

If you create a device with a custom JoinEUI but don't claim that prefix on your tenant, join requests vanish.

### Diagnosis

1. Stream network server events during join attempts
2. If you see **zero events** despite active transmission → JoinEUI routing issue
3. Compare with a working device - what JoinEUI does it use?

### Solution

Use a JoinEUI prefix that is claimed on your network tenant:
1. Check what JoinEUIs other working devices on your tenant use
2. Change your device to use one of those JoinEUIs
3. This typically requires delete+recreate on the network server

---

## Issue 5: ADR (Adaptive Data Rate) Loops

### Symptom

Device successfully joins but then loses connectivity:
```
INFO: Event received: JOINED
... (some uplinks succeed) ...
INFO: Event received: NO_FREE_CHANNEL
... (uplinks start failing) ...
```

### Root Cause

ADR commands from the network are reducing TX power or increasing data rate beyond what your RF environment supports.

### Solution

Disable ADR during initial testing:
```cpp
// In device firmware
lorawan_set_adr(false);
```

Or use fixed DR/power settings until RF environment is characterized.

---

## Quick Reference: Join Failure Decision Tree

```
Join Request Sent?
├── NO → Check UART wiring, baud rate, credentials
└── YES → Gateway Receives It?
    ├── NO → Check frequency plan, sub-band, antenna, gateway range
    └── YES → Network Server Events?
        ├── ZERO EVENTS → JoinEUI not claimed (silent drop)
        └── EVENTS EXIST → Check response
            ├── Join Accept Sent → Device receives it?
            │   ├── NO → Check RX timing / crystal calibration
            │   └── YES but rejects → JoinNonce mismatch (replay protection)
            └── No Accept → AppKey mismatch or device not registered
```

---

## Related Resources

- [LoRaWAN 1.0.4 Specification](https://lora-alliance.org/resource_hub/lorawan-specification-v1-0-4/)
- [The Things Industries Documentation](https://www.thethingsindustries.com/docs/)
- [ChirpStack Documentation](https://www.chirpstack.io/docs/)
- [Semtech LoRa Developer Portal](https://lora-developers.semtech.com/)
